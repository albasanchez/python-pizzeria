<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Pizzeria UCAB</title>
    <script type='text/javascript'>
      const available_ingredients = {{ ingredients|safe }};
      const available_sizes = {{ sizes|safe }};
      const available_drinks = {{ drinks|safe }};
    </script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'orders/style.css' %}">
    <script src="{% static 'orders/services.js' %}"></script>
  </head>
  <body>
    <div id="app">
      <v-app>
        <v-app-bar app color="red darken-4" dark dense>
          <v-app-bar-nav-icon><v-icon>mdi-pizza</v-icon></v-app-bar-nav-icon>
          <v-toolbar-title v-if="status!='SENDED'">Pizzeria UCAB: ¡Elabora tu orden aquí!</v-toolbar-title>
          <v-toolbar-title v-if="status=='SENDED'">Pizzeria UCAB: ¡Verifica tu pedido!</v-toolbar-title>
        </v-app-bar>
        <v-main class="background">
          <v-container fluid>
            <v-row>
              <v-col v-if="status==''">
                <v-form ref="form" v-model="valid" lazy-validation>
                  <v-stepper v-model="e1">
                    <v-stepper-header>
                      <v-stepper-step :complete="e1 > 1" step="1">
                        Cliente
                      </v-stepper-step>
                  
                      <v-divider></v-divider>
                  
                      <v-stepper-step :complete="e1 > 2" step="2">
                        Pizzas
                      </v-stepper-step>
                  
                      <v-divider></v-divider>
                  
                      <v-stepper-step :complete="e1 > 3" step="3">
                        Bebidas
                      </v-stepper-step>

                      <v-divider></v-divider>
                      
                      <v-stepper-step step="4">
                        Delivery
                      </v-stepper-step>
                    </v-stepper-header>
                  
                    <v-stepper-items>
                      <v-stepper-content step="1">
                        <v-row>
                          <v-col cols="6">
                            <v-text-field
                              v-model="order.client.name"
                              :rules="nameRules"
                              label="Nombre"
                              required
                            ></v-text-field>
                          </v-col>
                          <v-col cols="6">
                            <v-text-field
                              v-model="order.client.last_name"
                              :rules="nameRules"
                              label="Apellido"
                              required
                            ></v-text-field>
                          </v-col>
                        </v-row>
                        <v-row>
                          <v-col>
                            <v-text-field
                              v-model="order.client.email"
                              :rules="emailRules"
                              label="Email"
                              required
                            ></v-text-field>
                          </v-col>
                        </v-row>
                        <v-row>
                          <v-col class="d-flex justify-end">
                            <v-btn
                              :disabled="!order.client.name || !order.client.last_name || !order.client.email || !valid"
                              color="primary"
                              @click="e1 = 2"
                            >
                              Continuar
                            </v-btn>
                          </v-col>
                        </v-row>
                      </v-stepper-content>
                  
                      <v-stepper-content step="2">
                        <v-row>
                          <v-col class="d-flex justify-center">
                            <v-btn
                              class="add-button"
                              color="red darken-4"
                              dark
                              @click="order.pizzas.push({size: null, ingredients: []})"
                            >
                              Agregar pizza
                            </v-btn>
                          </v-col>
                        </v-row>
                        <v-card v-for="(pizza, index) in order.pizzas" :key="index" class="mb-6" color="grey lighten-3" elevation="0">
                          <v-card-title>
                            Pizza #[[index+1]]
                            <v-spacer></v-spacer>
                            <v-btn v-if="order.pizzas.length!=1" icon color="red darken-4" @click="order.pizzas.splice(index, 1)">
                              <v-icon>mdi-close</v-icon>
                            </v-btn>
                          </v-card-title>
                          <v-row class="card-row">
                            <v-col class="padding-top-0">
                              <v-select
                                v-model="order.pizzas[index].size"
                                :items="available_sizes"
                                :item-text="item => item.name +' ($'+ item.price + ')'"
                                :rules="[v => !!v || 'Item is required']"
                                label="Tamaño"
                                required
                                return-object
                              ></v-select>
                            </v-col>
                          </v-row>
                          <v-card-title class="subtitle padding-top-0 padding-bottom-0">Ingredientes</v-card-title>
                          <v-row class="card-row">
                            <v-col cols="4" v-for="(ingredient, ing_index) in available_ingredients" :key="ing_index">
                              <v-checkbox
                                class="ingredient-checkbox"
                                v-model="order.pizzas[index].ingredients"
                                :label="ingredient.name +' ($'+ ingredient.price + ')'"
                                :value="ingredient"
                              ></v-checkbox>
                            </v-col>
                          </v-row>
                        </v-card>
                
                        <v-row>
                          <v-col class="d-flex justify-end">
                            <v-btn text @click="e1 = 1">
                              Volver
                            </v-btn>
                            <v-btn
                              :disabled="invalidPizzas()"
                              color="primary"
                              @click="e1 = 3"
                            >
                              Continuar
                            </v-btn>
                          </v-col>
                        </v-row>
                      </v-stepper-content>
                  
                      <v-stepper-content step="3">
                        <v-row>
                          <v-col class="d-flex justify-center">
                            <v-btn
                              class="add-button"
                              color="red darken-4"
                              dark
                              @click="order.drinks.push({name: null, id: null})"
                            >
                              Agregar bebida
                            </v-btn>
                          </v-col>
                        </v-row>
                        <v-card v-for="(drink, index) in order.drinks" :key="index"  class="mb-6" color="grey lighten-3" elevation="0">
                          <v-card-title>
                            Bebida #[[index+1]]
                            <v-spacer></v-spacer>
                            <v-btn icon color="red darken-4" @click="order.drinks.splice(index, 1)">
                              <v-icon>mdi-close</v-icon>
                            </v-btn>
                          </v-card-title>
                          <v-row class="card-row">
                            <v-col class="padding-top-0">
                              <v-select
                                v-model="order.drinks[index].name"
                                :items="available_drinks"
                                :item-text="item => item.name +' ($'+ item.price + ')'"
                                :rules="[v => !!v || 'Item is required']"
                                label="Bebida"
                                required
                                return-object
                              ></v-select>
                            </v-col>
                          </v-row>
                        </v-card>
                  
                        <v-row>
                          <v-col class="d-flex justify-end">
                            <v-btn text @click="e1 = 2">
                              Volver
                            </v-btn>
                            <v-btn
                              :disabled="invalidDrinks()"
                              color="primary"
                              @click="e1 = 4"
                            >
                              Continuar
                            </v-btn>
                          </v-col>
                        </v-row>
                      </v-stepper-content>

                      <v-stepper-content step="4">
                        <v-row class="padding-bottom-0">
                          <v-col>
                            <v-checkbox
                              v-model="checkbox_delivery"
                              :label="'¿Desea agregar delivery por un precio de $'+ [[order.delivery.price]] + '?'"
                            ></v-checkbox>
                          </v-col>
                        </v-row>
                        <v-row v-if="checkbox_delivery" class="delivery-row">
                          <v-col>
                            <v-textarea
                              name="direction"
                              filled
                              label="Dirección"
                              auto-grow
                              v-model="order.delivery.direction"
                            ></v-textarea>
                          </v-col>
                        </v-row>
                      
                        <v-row>
                          <v-col class="d-flex justify-end">
                            <v-btn text @click="e1 = 3">
                              Volver
                            </v-btn>
                            <v-btn
                              color="primary"
                              @click="calculateOrder"
                              :loading="status == 'SENDING'"
                              :disabled="invalidDirection()">
                            </v-btn>
                          </v-col>
                        </v-row>
                      </v-stepper-content>
                    </v-stepper-items>
                  </v-stepper>
                </v-form>
              </v-col>
              <v-col v-if="status=='SENDED'">
                <v-card elevation="2">
                  <v-card-title>Resumen</v-card-title>

                  <span v-if="order.client.name && order.client.last_name && order.client.email">
                    <v-divider class="mx-4"></v-divider>
                    <v-card-title class="subtitle padding-bottom-0">Cliente</v-card-title>
                    <v-row>
                      <v-col>
                        <v-card-text class="padding-top-0" >
                          <b>Nombre:</b> [[order.client.name]] [[order.client.last_name]]
                        </v-card-text>
                      </v-col>
                      <v-col>
                        <v-card-text class="padding-top-0">
                          <b>Email:</b> [[order.client.email]]</v-card-text>
                      </v-col>
                    </v-row>
                  </span>
                  
                  <span v-if="order.pizzas[0].size">
                    <v-divider class="mx-4"></v-divider>
                    <v-card-title class="subtitle padding-bottom-0">Pizzas</v-card-title>
                    <v-row>
                      <v-col>
                        <v-card-text class="padding-top-0">
                          <v-row>
                            <v-col cols="4" v-for="(pizza, index) in order.pizzas" :key="index">
                              <b class="small-title">Pizza [[index+1]]</b> <br>
                              <b>Tamaño:</b> [[pizza.size.name]] <br>
                              <span v-if="pizza.ingredients.length>0">
                                <b>Ingredientes:</b>
                                <ul>
                                  <li v-for="(ingredient, index) in pizza.ingredients" :key="index">
                                    [[ingredient.name]]
                                  </li>
                                </ul>
                              </span>
                            </v-col>
                          </v-row>
                        </v-card-text>
                      </v-col>
                    </v-row>
                  </span>

                  <span v-if="order.drinks.length>0">
                    <v-divider class="mx-4"></v-divider>
                    <v-card-title class="subtitle padding-bottom-0">Bebidas</v-card-title>
                    <v-row>
                      <v-col>
                        <v-card-text class="padding-top-0">
                          <v-row v-for="(drink, index) in order.drinks" :key="index">
                            <v-col>
                              Bebida [[index+1]]. [[drink.name]]
                            </v-col>
                          </v-row>
                        </v-card-text>
                      </v-col>
                    </v-row>
                  </span>

                  <span v-if="checkbox_delivery">
                    <v-divider class="mx-4"></v-divider>
                    <v-card-title class="subtitle padding-bottom-0">Delivery</v-card-title>
                    <v-row>
                      <v-col>
                        <v-card-text class="padding-top-0">Dirección: [[order.delivery.direction]]</v-card-text>
                      </v-col>
                    </v-row>
                  </span>
                </v-card>
              </v-col>
            </v-row>
          </v-container>
        </v-main>
      </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script>
      var app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        vuetify: new Vuetify(),
        data: {
            // Page data
            e1: 1,
            nameRules: [
              v => !!v || 'Name is required',
            ],
            emailRules: [
              v => !!v || 'E-mail is required',
              v => /.+@.+\..+/.test(v) || 'E-mail must be valid',
            ],
            valid: true,
            status: "",
            // DB Data
            available_sizes: available_sizes,
            available_ingredients: available_ingredients,
            available_drinks: available_drinks,
            // Order data
            checkbox_drink: false,
            checkbox_delivery: false,
            order: {
              client: {
                name: 'Alba',
                last_name: 'Sanchez',
                email: 'alba@g.c',
              },
              pizzas: [
                {
                  size: {id: 1, name: "Grande", price: 20},
                  ingredients: [],
                },
                {
                  size: { id: 2, name: "Mediana", price: 16 },
                  ingredients: [{ id: 1, name: "Maíz", price: 2.5 }, { id: 4, name: "Tomates secos", price: 7 }],
                },
                {
                  size: { id: 2, name: "Mediana", price: 16 },
                  ingredients: [{ id: 3, name: "Cebolla", price: 2 }, { id: 8, name: "Tocineta", price: 4.7 }, { id: 7, name: "Piña", price: 3 }],
                },
              ],
              drinks: [],
              delivery: {
                direction: "",
                price: 5
              }
            },
        },
        methods: {
          async calculateOrder(){
            this.status = "SENDING"
            await sendRequest("{% url 'calculate-order' %}", "{{ csrf_token }}", {"order": this.order})
            this.status = "SENDED"
          },
          invalidPizzas() {
            let invalid = false;
            this.order.pizzas.forEach(pizza => {
              if(!pizza.size) {
                invalid = true
              }
            });
            return invalid;
          },
          invalidDrinks() {
            if (this.order.drinks.length==0){
              return false;
            } else {
              let invalid = false;
              this.order.drinks.forEach(drink => {
                if (!drink.name) {
                  invalid = true
                }
              });
              return invalid;
            }
          },
          invalidDirection() {
            if(this.checkbox_delivery == false) {
              return false
            } else {
              return !this.order.delivery.direction
            }
          }
        },
        watch: {
        }
      });
    </script>
  </body>
</html>